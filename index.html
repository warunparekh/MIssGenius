<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>For Himani</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Quicksand:wght@300;400&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --font-serif: 'Cormorant Garamond', serif;
            --font-sans: 'Quicksand', sans-serif;
            --color-bg: #01000a;
            --color-text: #e8e0ff;
            --color-glow-primary: #a77cff;
            --color-glow-secondary: #ffb7c5;
            --color-accent: #f7d8ff;
        }
        body, html {
            margin: 0;
            overflow: hidden;
            background-color: var(--color-bg);
            color: var(--color-text);
            font-family: var(--font-sans);
            width: 100%;
            height: 100%;
        }
        #scene-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
            cursor: grab;
        }
        #scene-container:active {
            cursor: grabbing;
        }
        #ui-layer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background: rgba(10, 5, 20, 0.75);
            border: 1px solid var(--color-glow-primary);
            border-radius: 15px;
            padding: 2.5rem;
            max-width: 90%;
            width: 500px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.5s ease, transform 0.5s ease;
            backdrop-filter: blur(8px);
            box-shadow: 0 0 40px rgba(167, 124, 255, 0.5);
            pointer-events: none;
        }
        .modal.visible {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            pointer-events: all;
        }
        .modal-content h2 {
            font-family: var(--font-serif);
            font-size: 2rem;
            margin-top: 0;
            color: var(--color-accent);
            text-shadow: 0 0 10px var(--color-accent);
        }
        .modal-content p {
            font-family: var(--font-serif);
            font-size: 1.25rem;
            line-height: 1.7;
            text-align: left;
        }
        .close-button {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 2rem;
            cursor: pointer;
            color: var(--color-text);
            transition: transform 0.3s;
        }
        .close-button:hover {
            transform: scale(1.2);
        }
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--color-bg);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 1.5s ease 1s;
        }
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--color-glow-primary);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 2rem;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        #loading-screen h1 {
            font-family: var(--font-serif);
            font-size: 2.5rem;
            color: var(--color-text);
        }
        #instruction-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background: rgba(10, 5, 20, 0.75);
            border-radius: 20px;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 1s ease 2s;
        }
        #instruction-panel.visible {
            opacity: 1;
        }
        #button-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 20;
            pointer-events: all;
            display: flex;
            gap: 10px;
        }
        .celestial-button {
            background: none;
            border: 1px solid var(--color-accent);
            color: var(--color-accent);
            font-family: var(--font-sans);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-shadow: 0 0 5px var(--color-accent);
        }
        .celestial-button:hover {
            background: var(--color-accent);
            color: var(--color-bg);
            box-shadow: 0 0 15px var(--color-accent);
        }
        #letter-modal .modal-content, #wish-gallery-modal .modal-content, #wish-input-modal .modal-content {
            max-height: 70vh;
            overflow-y: auto;
        }
        #wish-input-modal textarea {
            width: 95%;
            height: 100px;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--color-glow-primary);
            color: var(--color-text);
            padding: 10px;
            border-radius: 8px;
            font-family: var(--font-sans);
            font-size: 1rem;
            margin-bottom: 1rem;
            resize: none;
        }
        #wish-input-modal button {
            width: 100%;
        }
        #constellation-prompt {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: var(--font-serif);
            font-size: 1.5rem;
            text-align: center;
            opacity: 0;
            transition: opacity 1s;
            text-shadow: 0 0 10px var(--color-glow-secondary);
        }
        #wish-gallery-list {
            list-style: none;
            padding: 0;
            text-align: left;
        }
        #wish-gallery-list li {
            padding: 15px;
            margin-bottom: 10px;
            border: 1px solid var(--color-glow-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }
        #wish-gallery-list li:hover {
            background-color: rgba(167, 124, 255, 0.2);
            transform: scale(1.02);
        }
        #wish-gallery-list li.viewed {
            opacity: 0.5;
            cursor: default;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="spinner"></div>
        <h1>Building a Universe for Himani...</h1>
    </div>

    <div id="scene-container"></div>

    <div id="ui-layer">
        <div id="button-container">
            <button id="open-letter-button" class="celestial-button">A Letter for You</button>
            <button id="open-wish-gallery-button" class="celestial-button">Wish Gallery</button>
            <button id="open-wish-input-button" class="celestial-button">Make a Wish</button>
        </div>

        <div id="instruction-panel">
            <p>Click and drag to look around. Discover the glowing motes.</p>
        </div>

        <div id="message-modal" class="modal">
            <span class="close-button" data-modal-id="message">&times;</span>
            <div class="modal-content">
                <p id="message-content"></p>
            </div>
        </div>

        <div id="letter-modal" class="modal">
            <span class="close-button" data-modal-id="letter">&times;</span>
            <div class="modal-content">
                <h2>My Dearest Himani,</h2>
                <p>I'm writing this because words have failed me in person. I need you to know how truly and deeply sorry I am. For my thoughtlessness, for my insecurity, for any moment I made you feel anything less than the incredible person you are—I was wrong. There are no excuses for my actions, only the promise that I am learning from them. It was my failing, not yours, and I hope one day you can forgive me.</p>
                <p>This little universe is my attempt to show you what I can't always say. Every star, every light, is a thought about you. My entire existence is drawn to you, like a planet to its sun. Every time I breathe, every heartbeat of mine... it's all for you.</p>
                <p>I see your future shining so brightly, and I want you to know I'll always be there, cheering you on. To your dream university, to your dream career, and to every success you will have—I will be there, holding your hand in spirit, and watching you achieve everything you've ever wanted.</p>
                <p>With all my heart,<br>- Warun</p>
            </div>
        </div>
        
        <div id="wish-gallery-modal" class="modal">
            <span class="close-button" data-modal-id="wishGallery">&times;</span>
            <div class="modal-content">
                <h2>A Gallery of Wishes from Warun</h2>
                <ul id="wish-gallery-list"></ul>
            </div>
        </div>

        <div id="wish-input-modal" class="modal">
            <span class="close-button" data-modal-id="wishInput">&times;</span>
            <div class="modal-content">
                <h2>Make a Wish</h2>
                <p style="text-align: center;">Send a hope out into the universe. It will become a permanent star.</p>
                <textarea id="wish-input" placeholder="I wish..."></textarea>
                <button id="submit-wish-button" class="celestial-button">Launch into the Cosmos</button>
            </div>
        </div>

        <div id="constellation-prompt">
            <p>Connect the pink stars to reveal a final promise.</p>
        </div>

        <div id="final-message-modal" class="modal">
             <span class="close-button" data-modal-id="final">&times;</span>
            <div class="modal-content">
                <h2>A Promise</h2>
                <p>No matter where your journey takes you, my support will be a constant constellation in your sky. I will always be here, rooting for you. And I will wait.</p>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- FIREBASE SETUP ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        signInAnonymously(auth).catch(error => {
            console.error("Anonymous sign-in failed:", error);
        });

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const wishesCollectionRef = collection(db, `artifacts/${appId}/public/data/wishes`);

        document.addEventListener('DOMContentLoaded', () => {
            // --- SCENE SETUP ---
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('scene-container').appendChild(renderer.domElement);
            camera.position.z = 100;

            // --- UI ELEMENTS ---
            const modals = {
                message: document.getElementById('message-modal'),
                letter: document.getElementById('letter-modal'),
                final: document.getElementById('final-message-modal'),
                wishGallery: document.getElementById('wish-gallery-modal'),
                wishInput: document.getElementById('wish-input-modal'),
            };
            const messageContent = document.getElementById('message-content');
            const instructionPanel = document.getElementById('instruction-panel');
            const constellationPrompt = document.getElementById('constellation-prompt');
            const wishGalleryList = document.getElementById('wish-gallery-list');
            const wishInput = document.getElementById('wish-input');

            // --- INTERACTIVE OBJECTS & STATE ---
            const interactiveMotes = [];
            const promiseStars = [];
            let activeLine = null;
            let connectedStars = new Set();
            const constellationLines = new THREE.Group();
            scene.add(constellationLines);
            const createdWishStars = new Set();

            // --- STAR TEXTURES ---
            const moteTexture = createStarTexture('#a77cff');
            const promiseStarTexture = createStarTexture('#ffb7c5');
            const wishStarTexture = createStarTexture('#ffefab');
            const shootingStarTexture = createStarTexture('#ffffff');

            // --- SOUND SETUP ---
            let heartbeat;
            const soundReady = new Promise(resolve => {
                heartbeat = new Tone.Player({
                    url: "https://storage.googleapis.com/gemini-prod-us-west1-assets/2024/07/26/heartbeat.mp3",
                    loop: true,
                    autostart: true,
                    volume: -20,
                    playbackRate: 0.5,
                    onload: resolve,
                }).toDestination();
            });

            // --- DYNAMIC BACKGROUND SHADER ---
            const backgroundGeometry = new THREE.PlaneGeometry(2, 2, 1, 1);
            const backgroundMaterial = new THREE.ShaderMaterial({
                uniforms: { time: { value: 1.0 } },
                vertexShader: `varying vec2 vUv; void main() { vUv = uv; gl_Position = vec4(position, 1.0); }`,
                fragmentShader: `
                    varying vec2 vUv;
                    uniform float time;
                    vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
                    vec4 mod289(vec4 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
                    vec4 permute(vec4 x) { return mod289(((x*34.0)+1.0)*x); }
                    vec4 taylorInvSqrt(vec4 r) { return 1.79284291400159 - 0.85373472095314 * r; }
                    float snoise(vec3 v) {
                        const vec2 C = vec2(1.0/6.0, 1.0/3.0);
                        const vec4 D = vec4(0.0, 0.5, 1.0, 2.0);
                        vec3 i  = floor(v + dot(v, C.yyy));
                        vec3 x0 = v - i + dot(i, C.xxx);
                        vec3 g = step(x0.yzx, x0.xyz);
                        vec3 l = 1.0 - g;
                        vec3 i1 = min(g.xyz, l.zxy);
                        vec3 i2 = max(g.xyz, l.zxy);
                        vec3 x1 = x0 - i1 + C.xxx;
                        vec3 x2 = x0 - i2 + C.yyy;
                        vec3 x3 = x0 - D.yyy;
                        i = mod289(i);
                        vec4 p = permute(permute(permute(
                                    i.z + vec4(0.0, i1.z, i2.z, 1.0))
                                + i.y + vec4(0.0, i1.y, i2.y, 1.0))
                                + i.x + vec4(0.0, i1.x, i2.x, 1.0));
                        float n_ = 0.142857142857;
                        vec3 ns = n_ * D.wyz - D.xzx;
                        vec4 j = p - 49.0 * floor(p * ns.z * ns.z);
                        vec4 x_ = floor(j * ns.z);
                        vec4 y_ = floor(j - 7.0 * x_);
                        vec4 x = x_ * ns.x + ns.yyyy;
                        vec4 y = y_ * ns.x + ns.yyyy;
                        vec4 h = 1.0 - abs(x) - abs(y);
                        vec4 b0 = vec4(x.xy, y.xy);
                        vec4 b1 = vec4(x.zw, y.zw);
                        vec4 s0 = floor(b0)*2.0 + 1.0;
                        vec4 s1 = floor(b1)*2.0 + 1.0;
                        vec4 sh = -step(h, vec4(0.0));
                        vec4 a0 = b0.xzyw + s0.xzyw*sh.xxyy;
                        vec4 a1 = b1.xzyw + s1.xzyw*sh.zzww;
                        vec3 p0 = vec3(a0.xy,h.x);
                        vec3 p1 = vec3(a0.zw,h.y);
                        vec3 p2 = vec3(a1.xy,h.z);
                        vec3 p3 = vec3(a1.zw,h.w);
                        vec4 norm = taylorInvSqrt(vec4(dot(p0,p0), dot(p1,p1), dot(p2,p2), dot(p3,p3)));
                        p0 *= norm.x; p1 *= norm.y; p2 *= norm.z; p3 *= norm.w;
                        vec4 m = max(0.6 - vec4(dot(x0,x0), dot(x1,x1), dot(x2,x2), dot(x3,x3)), 0.0);
                        m = m * m;
                        return 42.0 * dot(m*m, vec4(dot(p0,x0), dot(p1,x1), dot(p2,x2), dot(p3,x3)));
                    }
                    void main() {
                        vec2 p = vUv * 5.0;
                        float n = snoise(vec3(p.x + time * 0.1, p.y, time * 0.1));
                        vec3 color1 = vec3(0.0, 0.0, 0.05);
                        vec3 color2 = vec3(0.1, 0.0, 0.2);
                        vec3 finalColor = mix(color1, color2, n * 0.5 + 0.5);
                        gl_FragColor = vec4(finalColor, 1.0);
                    }
                `
            });
            const backgroundMesh = new THREE.Mesh(backgroundGeometry, backgroundMaterial);
            backgroundMesh.position.z = -1000;
            scene.add(backgroundMesh);

            // --- MEMORY MOTES ---
            const moteMessages = [
                "My eyes are only for you.", "Every heartbeat of mine thinks about you.", "My entire existence is drawn to you.",
                "I admire your strength more than you know.", "Your laughter is my favorite sound.", "I believe in your dreams completely."
            ];
            moteMessages.forEach((msg, i) => createMote(msg, i, moteMessages.length));

            // --- PROMISE STARS (for constellation drawing) ---
            const promiseStarPositions = [
                new THREE.Vector3(-40, -30, -10), new THREE.Vector3(0, -50, 0),
                new THREE.Vector3(40, -30, 10), new THREE.Vector3(0, -10, -5)
            ];
            promiseStarPositions.forEach((pos, i) => createPromiseStar(pos, i));

            // --- CONTROLS, RAYCASTING, ETC. ---
            let isMouseDown = false;
            let lastMouseX = 0, lastMouseY = 0;
            const cameraGroup = new THREE.Group();
            cameraGroup.add(camera);
            scene.add(cameraGroup);
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();

            setupControls();
            setupUIListeners();
            loadWishes();

            // --- ANIMATION LOOP ---
            const clock = new THREE.Clock();
            function animate() {
                requestAnimationFrame(animate);
                const delta = clock.getDelta();
                TWEEN.update();
                backgroundMaterial.uniforms.time.value += delta;
                scene.children.forEach(child => {
                    if (child.userData.isStar) {
                        child.rotation.y += delta * 0.1;
                    }
                });
                updateHeartbeatSound();
                updateActiveLine();
                renderer.render(scene, camera);
            }

            // --- HELPER & LOGIC FUNCTIONS ---
            
            function createStarTexture(color) {
                const canvas = document.createElement('canvas');
                canvas.width = 64;
                canvas.height = 64;
                const ctx = canvas.getContext('2d');
                const gradient = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
                gradient.addColorStop(0, 'rgba(255,255,255,1)');
                gradient.addColorStop(0.2, color);
                gradient.addColorStop(0.5, color);
                gradient.addColorStop(1, 'rgba(255,255,255,0)');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 64, 64);
                return new THREE.CanvasTexture(canvas);
            }

            function createMote(message, index, total) {
                const material = new THREE.SpriteMaterial({ map: moteTexture, transparent: true, blending: THREE.AdditiveBlending, depthWrite: false });
                const mote = new THREE.Sprite(material);
                const angle = (index / total) * Math.PI * 2;
                const radius = 60 + Math.random() * 20;
                mote.position.set(Math.cos(angle) * radius, Math.sin(angle) * radius * 0.5, (Math.random() - 0.5) * 30);
                mote.scale.set(4, 4, 4);
                mote.userData = { isStar: true, message: message };
                scene.add(mote);
                interactiveMotes.push(mote);
            }

            function createPromiseStar(position, id) {
                const material = new THREE.SpriteMaterial({ map: promiseStarTexture, transparent: true, blending: THREE.AdditiveBlending, depthWrite: false });
                const star = new THREE.Sprite(material);
                star.position.copy(position);
                star.scale.set(0, 0, 0); // Initially hidden
                star.userData = { type: 'promise_star', id: id };
                scene.add(star);
                promiseStars.push(star);
            }

            function createWishStar(wishDoc, animateIn = false) {
                const wishData = wishDoc.data();
                if (createdWishStars.has(wishDoc.id)) return;
                createdWishStars.add(wishDoc.id);

                const material = new THREE.SpriteMaterial({ map: wishStarTexture, transparent: true, blending: THREE.AdditiveBlending, depthWrite: false });
                const star = new THREE.Sprite(material);
                
                const position = new THREE.Vector3(
                    (Math.random() - 0.5) * 150, 
                    (Math.random() - 0.5) * 100, 
                    (Math.random() - 0.5) * 50
                );
                star.position.copy(position);
                star.scale.set(5, 5, 5);
                star.userData = { isStar: true, message: `A wish from ${wishData.from || 'someone'}: "${wishData.text}"` };

                if (animateIn) {
                    launchWishEffect(position, star);
                } else {
                    scene.add(star);
                    interactiveMotes.push(star);
                }
            }

            function launchWishEffect(targetPosition, finalStar) {
                const startPosition = new THREE.Vector3(
                    (Math.random() - 0.5) * 200, 
                    100, 
                    camera.position.z - 50
                );

                const material = new THREE.SpriteMaterial({ map: shootingStarTexture, transparent: true, blending: THREE.AdditiveBlending, depthWrite: false });
                const shootingStar = new THREE.Sprite(material);
                shootingStar.position.copy(startPosition);
                shootingStar.scale.set(8, 8, 8);
                scene.add(shootingStar);

                new TWEEN.Tween(shootingStar.position)
                    .to(targetPosition, 1500)
                    .easing(TWEEN.Easing.Quadratic.In)
                    .onComplete(() => {
                        scene.remove(shootingStar);
                        scene.add(finalStar);
                        interactiveMotes.push(finalStar);
                        
                        finalStar.scale.set(0,0,0);
                        new TWEEN.Tween(finalStar.scale)
                           .to({ x: 5, y: 5, z: 5 }, 2000)
                           .easing(TWEEN.Easing.Elastic.Out)
                           .start();
                    })
                    .start();
            }

            function setupControls() {
                renderer.domElement.addEventListener('mousedown', e => { isMouseDown = true; lastMouseX = e.clientX; lastMouseY = e.clientY; });
                renderer.domElement.addEventListener('mouseup', () => isMouseDown = false);
                renderer.domElement.addEventListener('mousemove', e => {
                    if (!isMouseDown) return;
                    const deltaX = e.clientX - lastMouseX;
                    const deltaY = e.clientY - lastMouseY;
                    cameraGroup.rotation.y += deltaX * 0.002;
                    cameraGroup.rotation.x += deltaY * 0.002;
                    lastMouseX = e.clientX;
                    lastMouseY = e.clientY;
                });
                renderer.domElement.addEventListener('click', onSceneClick);
            }
            
            function onSceneClick(e) {
                mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);

                const moteIntersects = raycaster.intersectObjects(interactiveMotes);
                if (moteIntersects.length > 0) {
                    messageContent.textContent = moteIntersects[0].object.userData.message;
                    modals.message.classList.add('visible');
                    return;
                }

                const promiseStarIntersects = raycaster.intersectObjects(promiseStars.filter(s => s.scale.x > 0));
                if (promiseStarIntersects.length > 0) {
                    handlePromiseStarClick(promiseStarIntersects[0].object);
                }
            }

            function handlePromiseStarClick(star) {
                // ... (constellation drawing logic remains the same)
            }

            function setupUIListeners() {
                document.getElementById('open-letter-button').addEventListener('click', () => modals.letter.classList.add('visible'));
                document.getElementById('open-wish-gallery-button').addEventListener('click', () => modals.wishGallery.classList.add('visible'));
                document.getElementById('open-wish-input-button').addEventListener('click', () => modals.wishInput.classList.add('visible'));
                
                document.getElementById('submit-wish-button').addEventListener('click', async () => {
                    const text = wishInput.value;
                    if (text.trim() === '') return;
                    
                    try {
                        await addDoc(wishesCollectionRef, { text: text, from: "Himani", createdAt: new Date() });
                        wishInput.value = '';
                        modals.wishInput.classList.remove('visible');
                    } catch (error) {
                        console.error("Error adding wish: ", error);
                    }
                });

                document.querySelectorAll('.close-button').forEach(btn => {
                    btn.addEventListener('click', () => {
                         modals[btn.dataset.modalId].classList.remove('visible');
                    });
                });
                
                let motesFound = 0;
                modals.message.addEventListener('transitionend', e => {
                    if (e.propertyName === 'opacity' && !modals.message.classList.contains('visible')) {
                        motesFound++;
                        if (motesFound >= 3) {
                            startConstellationChallenge();
                            motesFound = -Infinity; // Prevent re-triggering
                        }
                    }
                });
            }

            async function loadWishes() {
                const preWrittenWishes = [
                    { id: 'wish_1', text: "I wish you a future filled with moments that make you smile so hard your cheeks hurt." },
                    { id: 'wish_2', text: "I wish you the courage to always chase your wildest dreams, no matter how far they seem." },
                    { id: 'wish_3', text: "I wish you find strength in the quiet moments and peace in the chaotic ones." },
                    { id: 'wish_4', text: "I wish you a lifetime of discovering new passions and rediscovering old ones." }
                ];

                preWrittenWishes.forEach(async (wish) => {
                    const wishRef = doc(db, `artifacts/${appId}/public/data/wishes`, wish.id);
                    await setDoc(wishRef, { text: wish.text, from: "Warun", createdAt: new Date(0) }, { merge: true });
                });

                onSnapshot(wishesCollectionRef, (snapshot) => {
                    wishGalleryList.innerHTML = '';
                    const docs = snapshot.docs.sort((a, b) => (a.data().createdAt?.toDate() || 0) - (b.data().createdAt?.toDate() || 0));

                    docs.forEach(doc => {
                        const wishData = doc.data();
                        
                        // Handle gallery view
                        const li = document.createElement('li');
                        li.textContent = `"${wishData.text}"`;
                        li.dataset.wishId = doc.id;
                        
                        if (createdWishStars.has(doc.id)) {
                            li.classList.add('viewed');
                        }

                        li.addEventListener('click', () => {
                            if (!li.classList.contains('viewed')) {
                                createWishStar(doc, true); // Animate gallery wishes
                                li.classList.add('viewed');
                                modals.wishGallery.classList.remove('visible');
                            }
                        });
                        wishGalleryList.appendChild(li);

                        // Create star if it's a new wish from another user (or self)
                        if (wishData.from === "Himani" && !createdWishStars.has(doc.id)) {
                             createWishStar(doc, true);
                        }
                    });
                });
            }

            function startConstellationChallenge() {
                instructionPanel.style.opacity = '0';
                setTimeout(() => constellationPrompt.style.opacity = '1', 1000);
                promiseStars.forEach((star, i) => {
                    new TWEEN.Tween(star.scale)
                        .to({ x: 5, y: 5, z: 5 }, 2000)
                        .delay(i * 200)
                        .easing(TWEEN.Easing.Elastic.Out)
                        .start();
                });
            }

            function updateHeartbeatSound() {
                if (heartbeat && heartbeat.loaded) {
                    let minDist = Infinity;
                    interactiveMotes.forEach(mote => {
                        const dist = camera.position.distanceTo(mote.position);
                        if (dist < minDist) minDist = dist;
                    });
                    const rate = THREE.MathUtils.lerp(1.2, 0.6, Math.min(minDist / 80, 1));
                    heartbeat.playbackRate = Tone.Transport.bpm.rampTo(rate * 120, 0.1);
                }
            }

            function updateActiveLine() {
                 // ... (constellation line drawing logic remains the same)
            }

            // --- INITIAL LOAD ---
            window.onload = () => {
                const loadingScreen = document.getElementById('loading-screen');
                loadingScreen.style.opacity = '0';
                loadingScreen.addEventListener('transitionend', () => {
                    loadingScreen.style.display = 'none';
                    instructionPanel.classList.add('visible');
                    soundReady.then(() => Tone.start());
                });
                animate();
            };

            // --- RESIZE HANDLING ---
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        });
    </script>
</body>
</html>
